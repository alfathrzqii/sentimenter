{% extends 'layout.html' %}

{% block title %}Analisis Sentimen{% endblock %}
{% block page_title %}Analisis Sentimen{% endblock %}

{% block content %}
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <span><i class="fas {{ 'fa-exclamation-triangle' if category == 'danger' else 'fa-check-circle' }} margin-right: 10px;"></i> {{ message }}</span>
                    <button type="button" class="alert-close">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
        
        <!-- Card 1: Single Text Analysis -->
        <div class="card">
            <h2><i class="fas fa-keyboard" style="color: #3498db; margin-right: 10px;"></i> Analisis Teks Tunggal</h2>
            <p>Masukkan kalimat untuk mendeteksi sentimen secara instan.</p>

            <form method="POST" action="{{ url_for('analysis') }}">
                <div class="form-group">
                    <textarea name="text_input" rows="5" class="form-control" 
                              placeholder="Contoh: Pelayanan restoran ini sangat memuaskan..." required>{{ text }}</textarea>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic"></i> Analisis Sekarang
                    </button>
                </div>
            </form>

            {% if prediction %}
            <div class="result-highlight">
                <h4 style="margin-bottom: 0.5rem; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase;">Hasil Prediksi</h4>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 2rem; font-weight: 800; 
                        color: {% if prediction == 'Positif' %}#2ecc71{% elif prediction == 'Negatif' %}#e74c3c{% else %}#95a5a6{% endif %};">
                        {{ prediction }}
                    </span>
                    <i class="fas 
                        {% if prediction == 'Positif' %}fa-smile{% elif prediction == 'Negatif' %}fa-frown{% else %}fa-meh{% endif %}" 
                        style="font-size: 2rem; opacity: 0.5;"></i>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Card 2: Bulk File Analysis (Drag & Drop) -->
        <div class="card">
            <h2><i class="fas fa-file-upload" style="color: #2ecc71; margin-right: 10px;"></i> Analisis Massal (File)</h2>
            <p>Upload file CSV atau Excel untuk menganalisis ribuan ulasan sekaligus.</p>
            
            <form method="POST" enctype="multipart/form-data" action="{{ url_for('analysis') }}" id="bulk-form">
                
                <!-- Drag & Drop Zone -->
                <div class="form-group">
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-zone-content">
                            <i class="fas fa-cloud-upload-alt drop-zone-icon"></i>
                            <p class="drop-zone-text">Drag & Drop file di sini atau klik untuk memilih</p>
                            <p style="font-size: 0.8rem; color: #aaa;">Support: .csv, .xlsx</p>
                            <div id="file-name-display" style="margin-top: 10px; font-weight: bold; color: #3498db;"></div>
                        </div>
                        <input type="file" name="file" id="file" class="drop-zone-input" accept=".csv, .xlsx" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="text_column" class="form-label">Nama Kolom Teks</label>
                    <input type="text" name="text_column" id="text_column" class="form-control" placeholder="Contoh: review_text" required>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%;">
                    <i class="fas fa-rocket"></i> Proses File
                </button>
            </form>
        </div>

        <!-- Results Section -->
        {% if sentiment_counts %}
        <div class="card" id="results-section">
            <h2><i class="fas fa-chart-pie" style="color: #9b59b6; margin-right: 10px;"></i> Hasil Analisis</h2>
            
            <div style="display: flex; flex-wrap: wrap; gap: 30px; margin-top: 30px;">
                <div style="flex: 1; min-width: 300px; background: #f9f9f9; padding: 20px; border-radius: 12px;">
                    <h3 style="text-align: center; font-size: 1.1rem;">Distribusi Sentimen</h3>
                    <canvas id="barChartCanvas"></canvas>
                </div>
                <div style="flex: 1; min-width: 300px; background: #f9f9f9; padding: 20px; border-radius: 12px;">
                    <h3 style="text-align: center; font-size: 1.1rem;">Proporsi</h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="pieChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            {% if wordcloud %}
            <div style="margin-top: 40px; text-align: center;">
                <h3>Word Cloud</h3>
                <img src="data:image/png;base64,{{ wordcloud }}" alt="Word Cloud" 
                     style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            </div>
            {% endif %}
            
            <div style="margin-top: 40px;">
                 <h3>Data Preview</h3>
                 <div style="overflow-x: auto; border: 1px solid #eee; border-radius: 8px;">
                     {{ results_table|safe }}
                 </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Data Embedding -->
    <script id="sentiment-data" type="application/json">
        {% if sentiment_counts %}{{ sentiment_counts | tojson | safe }}{% else %}null{% endif %}
    </script>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Drag & Drop Interface Logic ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file');
        const fileNameDisplay = document.getElementById('file-name-display');
        const bulkForm = document.getElementById('bulk-form');

        if(dropZone && fileInput) {
            // Highlight on drag
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('dragover');
                }, false);
            });

            // Handle File Drop
            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files; // Assign dropped files to input
                updateFileName(files);
            });

            // Handle Click/Change
            fileInput.addEventListener('change', () => {
                updateFileName(fileInput.files);
            });

            function updateFileName(files) {
                if (files.length > 0) {
                    fileNameDisplay.textContent = `File dipilih: ${files[0].name}`;
                    fileNameDisplay.style.opacity = '1';
                }
            }
        }

        // --- 2. Form Submit Spinner ---
        if(bulkForm) {
            bulkForm.addEventListener('submit', () => {
                if(fileInput.value && document.getElementById('text_column').value) {
                    window.showSpinner();
                }
            });
        }

        // --- 3. Chart Logic (Refined) ---
        const countsEl = document.getElementById('sentiment-data');
        let counts = null;
        try { counts = JSON.parse(countsEl.textContent || 'null'); } catch(e) {}

        if (counts) {
            const labels = ['Positif', 'Netral', 'Negatif'];
            const data = [counts['Positif'] || 0, counts['Netral'] || 0, counts['Negatif'] || 0];
            const colors = ['#2ecc71', '#95a5a6', '#e74c3c'];

            // Bar Chart
            const barCtx = document.getElementById('barChartCanvas');
            if(barCtx) {
                new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah',
                            data: data,
                            backgroundColor: colors,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: true, color: '#eee' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // Pie Chart
            const pieCtx = document.getElementById('pieChartCanvas');
            if(pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut', // Modern doughnut style
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Scroll to results if they exist
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }
    });
</script>
{% endblock %}